---
title: "Tipologia i cicle de vida de les dades"
subtitle: "Pràctica 2"
author: "Esther Ruano, Carles Ventura"
date: "2025-05"
output:
  html_document:
    toc: yes
  pdf_document:
    toc: 
toc-title: "Índex"
---

```{r setup, include=FALSE}
# Configuració inicial
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

# Llibreries
library(tidyverse)
library(caret)
library(randomForest)
library(ggplot2)
library(patchwork)
library(dplyr)
library(cluster)
library(factoextra)
```

## 1. Carregar i preparar les dades

```{r}
# Carregar dades
df <- read.csv("data/student_depression_dataset.csv")

# Normalitzar noms de columnes
colnames(df) <- make.names(colnames(df))

# Eliminar columna ID
df <- df %>% select(-id)

# Convertir la variable resposta a factor
df$Depression <- as.factor(df$Depression)

# Variables quantitatives
df <- df %>%
  mutate(
    Age = as.numeric(Age),
    CGPA = as.numeric(CGPA),
    Work.Study.Hours = as.numeric(Work.Study.Hours)
  )

# Variables qualitatives
df <- df %>%
  mutate(
    Academic.Pressure = as.factor(Academic.Pressure),
    Job.Satisfaction = as.factor(Job.Satisfaction),
    Study.Satisfaction = as.factor(Study.Satisfaction),
    Work.Pressure = as.factor(Work.Pressure),
    City = as.factor(City),
    Degree = as.factor(Degree),
    Gender = as.factor(Gender),
    Profession = as.factor(Profession),
    Sleep.Duration = as.factor(Sleep.Duration),
    Dietary.Habits = as.factor(Dietary.Habits),
    Have.you.ever.had.suicidal.thoughts.. = as.factor(Have.you.ever.had.suicidal.thoughts..),
    Financial.Stress = as.factor(Financial.Stress),
    Family.History.of.Mental.Illness = as.factor(Family.History.of.Mental.Illness)
  )
```

## 2. Anàlisi explorativa de les variables quantitatives

```{r}
# Selecció
numeric_vars <- df %>% select(where(is.numeric))

# Histogrames
numeric_vars %>%
  pivot_longer(cols = everything(), names_to = "Variable", values_to = "Valor") %>%
  ggplot(aes(x = Valor)) +
  facet_wrap(~ Variable, scales = "free", ncol = 4) +
  geom_histogram(bins = 10, fill = "steelblue", color = "white") +
  theme_minimal() +
  labs(title = "Distribució de variables quantitatives")

# Boxplots
numeric_vars %>%
  pivot_longer(cols = everything(), names_to = "Variable", values_to = "Valor") %>%
  ggplot(aes(x = Variable, y = Valor)) +
  geom_boxplot(fill = "lightblue") +
  theme_minimal() +
  coord_flip() +
  labs(title = "Boxplots de les variables quantitatives")

```

## 3. Anàlisi explorativa de les variables qualitatives

```{r, fig.width=14, fig.height=50}
# Selecció de variables qualitatives
categorical_vars <- df %>% select(where(is.factor)) %>% select(-Depression)

# Crear gràfics separats
plot_city <- ggplot(df, aes(x = City)) +
  geom_bar(fill = "darkorange") +
  ggtitle("Distribució de City") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

plot_degree <- ggplot(df, aes(x = Degree)) +
  geom_bar(fill = "darkorange") +
  ggtitle("Distribució de Degree") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Altres variables qualitatives
other_vars <- setdiff(names(categorical_vars), c("City", "Degree"))

plots_others <- lapply(other_vars, function(var) {
  ggplot(df, aes_string(x = var)) +
    geom_bar(fill = "darkorange") +
    ggtitle(paste("Distribució de", var)) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          plot.title = element_text(size = 10))
})

# Combinar en layout: City i Degree en files separades, la resta 3 per fila
final_plot <- (plot_city / plot_degree) / wrap_plots(plots_others, ncol = 3)

print(final_plot)

```

## 4. Partició Train/Test

```{r}
set.seed(123)
train_index <- createDataPartition(df$Depression, p = 0.8, list = FALSE)
df_train <- df[train_index, ]
df_test <- df[-train_index, ]

```

## 5. Preprocessament i entrenament del model Random Forest

```{r}
# Eliminar variables City i Degree
df_train_rf <- df_train %>% select(-City, -Degree)
df_test_rf <- df_test %>% select(-City, -Degree)

# Convertir columnes de tipus factor amb mateixos nivells
char_vars <- names(df_train_rf)[sapply(df_train_rf, is.factor)]

for (var in char_vars) {
  levels_comb <- union(levels(df_train_rf[[var]]), levels(df_test_rf[[var]]))
  df_train_rf[[var]] <- factor(df_train_rf[[var]], levels = levels_comb)
  df_test_rf[[var]]  <- factor(df_test_rf[[var]],  levels = levels_comb)
}

# Entrenar model
set.seed(123)
rf_model <- randomForest(Depression ~ ., data = df_train_rf, ntree = 100, importance = TRUE)
print(rf_model)

```

## 6. Importància de les variables

```{r}
# Visualitzar la importància de les variables
varImpPlot(rf_model)
```

## 7. Avaluació del model

```{r}
# Prediccions sobre la mostra de test
pred_rf <- predict(rf_model, newdata = df_test_rf)

# Matriu de confusió per veure el rendiment
confusionMatrix(pred_rf, df_test_rf$Depression)
```


```{r}
# Mostrar files on City conté la paraula "less" (He vist que hi han alguns errors)
df %>% filter(str_detect(City, regex("less", ignore_case = TRUE)))
```

## 8. Model no supervisat: clustering d'estudiants

### 8.1 Selecció de variables rellevants

```{r}
# Torno a carregar el dataset per estar 100% segur que no està contaminat
df <- read.csv("data/student_depression_dataset.csv")
# Normalitzar noms de columnes
colnames(df) <- make.names(colnames(df))

# Eliminar columna ID
df <- df %>% select(-id)

# Eliminar files on Degree és "'Class 12'" (Pot ser un error....)
df <- df %>% filter(Degree != "'Class 12'")

# Crear df_cluster amb les columnes seleccionades
df_cluster <- df %>%
  select(Gender, Age, Degree, Profession,
         Academic.Pressure, Work.Pressure,
         CGPA, Study.Satisfaction, Job.Satisfaction,
         Sleep.Duration, Dietary.Habits,
         Have.you.ever.had.suicidal.thoughts..,
         Work.Study.Hours, Financial.Stress,
         Family.History.of.Mental.Illness)

```

### 8.2 Codificació i escalat de dades

```{r}
# Separem les qualitatives i quantitatives
qual_cols <- c("Gender", "Profession", "Academic.Pressure", "Work.Pressure",
               "Study.Satisfaction", "Job.Satisfaction", "Dietary.Habits",
               "Have.you.ever.had.suicidal.thoughts..", "Financial.Stress",
               "Family.History.of.Mental.Illness", "Sleep.Duration")
num_cols <- c("Age", "CGPA", "Work.Study.Hours")

# Dummy només per a qualitatives
dummies <- dummyVars(" ~ .", data = df_cluster[, qual_cols])
df_dummies <- predict(dummies, newdata = df_cluster[, qual_cols]) %>% as.data.frame()

# Combinar les columnes numèriques amb les dummies
df_numeric <- df_cluster[, num_cols]
df_combined <- bind_cols(df_numeric, df_dummies)

# Normalitzar les columnes numèriques dins del dataframe combinat
df_scaled <- df_combined
df_scaled[, num_cols] <- scale(df_combined[, num_cols])
```

### 8.3 Mètode del colze per determinar k

```{r}
set.seed(321)
wss <- map_dbl(1:10, function(k) {
  kmeans(df_scaled, centers = k, nstart = 10)$tot.withinss
})

plot(1:10, wss, type = "b", pch = 19,
     xlab = "Nombre de clústers (k)",
     ylab = "Total Within Sum of Squares",
     main = "Mètode del colze")
```

### 8.4 Aplicació de k-means amb k = 4

```{r}
set.seed(123)
kmeans_model <- kmeans(df_scaled, centers = 4, nstart = 25)
df$cluster <- as.factor(kmeans_model$cluster)
```

### 8.5 Valors mitjans de les variables quantitatives de cada clúster

```{r}
df %>%
  group_by(cluster) %>%
  summarise(
    Age_mean = mean(Age, na.rm = TRUE),
    CGPA_mean = mean(CGPA, na.rm = TRUE),
    WorkStudy_mean = mean(Work.Study.Hours, na.rm = TRUE),
    n = n()
  )
```

### 8.6 Distribucions de variables qualitatives

```{r echo = FALSE}

# Depression
df %>%
  group_by(cluster, Depression) %>%
  summarise(n = n(), .groups = 'drop') %>%
  group_by(cluster) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Depression, y = prop, fill = Depression)) +
  geom_col() +
  facet_wrap(~ cluster) +
  theme_minimal() +
  labs(title = "Distribució de Depression per clúster")

# Pensaments suïcides
df %>%
  group_by(cluster, Have.you.ever.had.suicidal.thoughts..) %>%
  summarise(n = n(), .groups = 'drop') %>%
  group_by(cluster) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Have.you.ever.had.suicidal.thoughts.., y = prop, fill = Have.you.ever.had.suicidal.thoughts..)) +
  geom_col() +
  facet_wrap(~ cluster) +
  theme_minimal() +
  labs(title = "Pensaments suïcides per clúster")

# Academic Pressure
df %>%
  group_by(cluster, Academic.Pressure) %>%
  summarise(n = n(), .groups = 'drop') %>%
  group_by(cluster) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Academic.Pressure, y = prop, fill = Academic.Pressure)) +
  geom_col() +
  facet_wrap(~ cluster) +
  theme_minimal() +
  labs(title = "Distribució de Academic Pressure per clúster")

# Financial Stress
df %>%
  group_by(cluster, Financial.Stress) %>%
  summarise(n = n(), .groups = 'drop') %>%
  group_by(cluster) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Financial.Stress, y = prop, fill = Financial.Stress)) +
  geom_col() +
  facet_wrap(~ cluster) +
  theme_minimal() +
  labs(title = "Distribució de Financial Stress per clúster")

# Family History of Mental Illness
df %>%
  group_by(cluster, Family.History.of.Mental.Illness) %>%
  summarise(n = n(), .groups = 'drop') %>%
  group_by(cluster) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Family.History.of.Mental.Illness, y = prop, fill = Family.History.of.Mental.Illness)) +
  geom_col() +
  facet_wrap(~ cluster) +
  theme_minimal() +
  labs(title = "Distribució de Family History of Mental Illness per clúster")

# Sleep Duration
df %>%
  group_by(cluster, Sleep.Duration) %>%
  summarise(n = n(), .groups = 'drop') %>%
  group_by(cluster) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Sleep.Duration, y = prop, fill = Sleep.Duration)) +
  geom_col() +
  facet_wrap(~ cluster) +
  theme_minimal() +
  labs(title = "Distribució de Sleep Duration per clúster")

# Hàbits alimentaris
df %>%
  group_by(cluster, Dietary.Habits) %>%
  summarise(n = n(), .groups = 'drop') %>%
  group_by(cluster) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Dietary.Habits, y = prop, fill = Dietary.Habits)) +
  geom_col() +
  facet_wrap(~ cluster) +
  theme_minimal() +
  labs(title = "Distribució dels hàbits alimentaris per clúster")

# Degree
df %>%
  group_by(cluster, Degree) %>%
  summarise(n = n(), .groups = 'drop') %>%
  group_by(cluster) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Degree, y = prop, fill = Degree)) +
  geom_col() +
  facet_wrap(~ cluster) +
  theme_minimal() +
  labs(title = "Distribució de Degree per clúster")


```

